<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MCU: CASE Library Usage and Updates</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">MCU
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">CASE Library Usage and Updates </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_README"></a> </p><blockquote class="doxtable">
<p >&zwj;[!IMPORTANT] DO THIS ONCE Before you begin, you need to add an SSH key to your GitHub account to allow PlatformIO to pull the CASE library. Follow these instructions to set up your SSH key: <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account">GitHub SSH Key Setup</a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md3"></a>
Updating CASE Library</h2>
<p >To update the CASE library, find the latest tag from the repository: <a href="https://github.com/hytech-racing/CASE_lib/tags">CASE Library Tags</a>. Once identified, update the <code>platformio.ini</code> file in this repository by replacing the version number in the following line:</p>
<div class="fragment"><div class="line">git+ssh://git@github.com/hytech-racing/CASE_lib.git#v(INSERT VERSION NUMBER HERE)</div>
</div><!-- fragment --><p >For example:</p>
<div class="fragment"><div class="line">git+ssh://git@github.com/hytech-racing/CASE_lib.git#v34</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4"></a>
Build, Test, and Run Instructions</h1>
<p >This project utilizes <a href="https://docs.platformio.org/en/latest/">PlatformIO</a> for building, testing, and packaging.</p>
<p >You can use PlatformIO in two ways:</p><ol type="1">
<li><a href="https://docs.platformio.org/en/latest/integration/ide/vscode.html#installation">As a VSCode extension</a></li>
<li><a href="https://docs.platformio.org/en/latest/core/installation/methods/installer-script.html">Through the PlatformIO Core CLI</a></li>
</ol>
<p >For a quick guide on using the VSCode extension, refer to the <a href="https://docs.platformio.org/en/latest/integration/ide/vscode.html#platformio-toolbar">PlatformIO toolbar</a>.</p>
<div class="image">
<img src="image.png" alt=""/>
<div class="caption">
IDE Upload and Build</div></div>
    <h2><a class="anchor" id="autotoc_md5"></a>
Environments</h2>
<p >There are two main environments for this project:</p><ul>
<li><code>test_env</code>: Used for native testing.</li>
<li><code>teensy41</code>: Used for building and deploying to the Teensy board.</li>
</ul>
<h2><a class="anchor" id="autotoc_md6"></a>
Building</h2>
<p >To build the project in a specific environment, switch to that environment in PlatformIO and use the build feature ( <code>check mark</code> icon) in VSCode. For CLI users, run:</p>
<div class="fragment"><div class="line">pio run -e teensy41</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md7"></a>
Testing</h2>
<p >Before merging code into the main branch, ensure all unit tests pass and the code compiles. The Continuous Integration (CI) system will verify this as well, but you can run the tests locally by switching to the <code>test_env</code> and executing the unit tests.</p>
<p >In VSCode, navigate to the <a href="https://docs.platformio.org/en/latest/integration/ide/vscode.html#project-tasks">Project Tasks Menu</a> and select <code>test_env &gt; Advanced &gt; Test</code> .</p>
<p >For CLI users, run:</p>
<div class="fragment"><div class="line">pio test -e test_env</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8"></a>
Uploading</h2>
<p >To upload to the Teensy, use the upload feature (arrow icon) in the PlatformIO toolbar, shown <a href="https://docs.platformio.org/en/latest/integration/ide/vscode.html#platformio-toolbar">here at number 3</a>.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Importance of Unit Tests</h2>
<blockquote class="doxtable">
<p >&zwj;[!WARNING] Unit tests MUST be maintained for functionality of the car. </p>
</blockquote>
<p>Unit tests ensure the stability of new features and code changes by verifying integration with the existing codebase. The unit tests for this project are located in the <code>test</code> folder and are run both locally and in the GitHub CI environment.</p>
<p >Note: CI testing currently only includes system-level tests, not hardware-dependent tests, which can be run locally.</p>
<p >View previous test results here: <a href="https://github.com/hytech-racing/MCU/actions">GitHub Actions</a>.</p>
<h2><a class="anchor" id="autotoc_md10"></a>
VSCode Setup for Auto-completion and Code Navigation</h2>
<p >For advanced code navigation and auto-completion, you can generate a <code>compile_commands.json</code> file for the build environment. This file is created using the <a href="https://docs.platformio.org/en/latest/integration/compile_commands.html">PlatformIO compiledb task</a>.</p>
<p >To generate the file:</p><ol type="1">
<li>Open the PlatformIO terminal in VSCode.</li>
<li>Run:</li>
</ol>
<div class="fragment"><div class="line">pio run -t compiledb -e teensy41</div>
</div><!-- fragment --><p >This will create the <code>compile_commands.json</code> file in the <code>.pio/build/teensy41</code> folder. You can configure VSCode to use this file by creating a <code>.vscode/c_cpp_properties.json</code> file with the following content:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;configurations&quot;: [</div>
<div class="line">        {</div>
<div class="line">            &quot;name&quot;: &quot;teensy41&quot;,</div>
<div class="line">            &quot;includePath&quot;: [</div>
<div class="line">                &quot;${workspaceFolder}/**&quot;</div>
<div class="line">            ],</div>
<div class="line">            &quot;cStandard&quot;: &quot;c17&quot;,</div>
<div class="line">            &quot;cppStandard&quot;: &quot;gnu++17&quot;,</div>
<div class="line">            &quot;intelliSenseMode&quot;: &quot;linux-gcc-x64&quot;,</div>
<div class="line">            &quot;compileCommands&quot;: &quot;${workspaceFolder}/.pio/build/teensy41/compile_commands.json&quot;</div>
<div class="line">        }</div>
<div class="line">    ],</div>
<div class="line">    &quot;version&quot;: 4</div>
<div class="line">}</div>
</div><!-- fragment --><p >Select this configuration using the VSCode command palette ( <code>Ctrl+Shift+P</code> ) and choosing <code>C/C++: Select a Configuration</code> .</p>
<h1><a class="anchor" id="autotoc_md11"></a>
Manual CASE Update (Legacy)</h1>
<ol type="1">
<li>Generate the <code>.zip</code> file for CASE from the HyTech_sim directory.</li>
<li>Run the <code>process_lib.py</code> script:</li>
</ol>
<div class="fragment"><div class="line">python3 process_lib.py HT08_CONTROL_SYSTEM.zip /path/to/MCU/lib/CASE_lib CASE_lib</div>
</div><!-- fragment --><p >Replace <code>/path/to/MCU</code> with your MCU path.</p>
<h1><a class="anchor" id="autotoc_md12"></a>
System Design and Structure</h1>
<h2><a class="anchor" id="autotoc_md13"></a>
Overview</h2>
<p >The project is built using different levels of abstraction to maintain logical structure while minimizing complexity.</p>
<h4><a class="anchor" id="autotoc_md14"></a>
State Diagram Legend</h4>
<p ><code>+</code> = Public <code>-</code> = Private</p>
<h3><a class="anchor" id="autotoc_md15"></a>
Level 1: State Machine goals for interface design and implementation</h3>
<ul>
<li><b>Reason for abstraction</b>: allows for easy swapping and adding of different portable systems and better <a href="https://en.wikipedia.org/wiki/Separation_of_concerns">separation of concerns</a> from <a href="https://www.techtarget.com/whatis/definition/business-logic">business logic</a> of the car to the business logic of the system.</li>
</ul>
<p >Any firmware project that needs to have different states needs each system that creates outputs and / or controls real systems of the car needs can be thought of as each system being controlled by the state machine. What I am thinking is that in a similar fashion to the shared bus, each system can contain a pointer to the state machine. The system can know what state the car is in and based on the state it can determine how to behave. Obviously the state machine also needs to know about what the system is doing as well to determine the state, so the system also needs to be able to pass back data to the state machine.</p>
<p >For example, our state machine needs to handle understand the state of the pedals system. The pedals dont know about the state of the car, but it does know whether or not the pedals are outputting valid data. Each system can manage their own state and the abstract system base class could contain the set of system-agnostic states through which the statemachine evaluates.</p>
<p >It is only within the logic of our state machine that the systems are allowed to communicate with one another.</p>
<p >The main idea is that each firmware project has a specific implementation of a state machine, however the systems are portable between firmware projects. Additionally, the systems remain as concrete.</p>
<div class="fragment"><div class="line">---</div>
<div class="line">title: state machine and system state abstraction</div>
<div class="line">---</div>
<div class="line">classDiagram</div>
<div class="line"> </div>
<div class="line">    </div>
<div class="line">    class car_state{</div>
<div class="line">        &lt;&lt;enumeration&gt;&gt;</div>
<div class="line">        STARTUP</div>
<div class="line">        INITIALIZING </div>
<div class="line">        READY_TO_DRIVE</div>
<div class="line">        ERROR</div>
<div class="line">    }</div>
<div class="line">    class StateMachine {</div>
<div class="line">        </div>
<div class="line">        </div>
<div class="line">        VectornavSystem* vectornav</div>
<div class="line">        PedalsSystel* pedals</div>
<div class="line">        DashInterface* dashboard</div>
<div class="line"> </div>
<div class="line">        DrivetrainSystem* drivetrain</div>
<div class="line"> </div>
<div class="line">        TorqueVectoringControllerSystem* tvc</div>
<div class="line">        LaunchControlSystem* launch_control</div>
<div class="line"> </div>
<div class="line">        car_state state</div>
<div class="line">        void init()</div>
<div class="line">        void loop()</div>
<div class="line">        bool set_state(car_state state)</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"> </div>
<div class="line">    car_state &quot;1&quot; *-- StateMachine : contains</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md16"></a>
level 2 portable Systems: interfaces, logic and structure</h3>
<ul>
<li><b>Reason for abstraction</b>: these Systems allow us to have board portable pieces so that when newer iterations of boards are made, the same systems that the previous iteration handled can be kept while only the hardware specific code changes.</li>
</ul>
<p >For instance, when a new MCU board is created with a new steering sensor input, code within the controller systems will not need to change, only that a new sensor system will be used within the state machine to feed the controller input.</p>
<p >below are some hypothetical system class definitions.</p>
<div class="fragment"><div class="line">---</div>
<div class="line">title: systems</div>
<div class="line">---</div>
<div class="line">classDiagram</div>
<div class="line">    class PedalsSystem{</div>
<div class="line">        -void validate_accel_pedals()</div>
<div class="line">        -void validate_brake_pedals()</div>
<div class="line"> </div>
<div class="line">        +void set_accel_pedal_values(float apps1, float apps2)</div>
<div class="line">        +void set_brake_pedal_values(float brake1, float brake2)</div>
<div class="line">        +float get_desired_throttle()</div>
<div class="line">        +void validate()</div>
<div class="line">    } </div>
<div class="line">    class TorqueVectoringControllerSystem{</div>
<div class="line">        </div>
<div class="line">        +void init(torque_vectoring_params params)</div>
<div class="line">        +void set_state_estimate(car_state state)</div>
<div class="line">        +torque_cmds get_torque_cmds(float desired_throttle)</div>
<div class="line">        -void calculate_estimated_wheel_slip()</div>
<div class="line">        -void predict()</div>
<div class="line">        -void run_pid()</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    class LaunchControlSystem{</div>
<div class="line">        </div>
<div class="line">        +void init(launch_control_params params)</div>
<div class="line">        +void set_state_estimate(car_state state)</div>
<div class="line">        +torque_cmds get_torque_cmds(float desired_throttle)</div>
<div class="line">        -void pull_from_table(float current_speed)</div>
<div class="line">    }</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md17"></a>
level 2 SPI / i2c data bus abstraction from hardware specific implementations</h3>
<ul>
<li><b>Reason for abstraction</b>: this allows us to create a specific type of system that uses a shared resource, for example multiple sensors on a SPI bus, that each have their own scaling to produce data for feeding other systems.</li>
</ul>
<p >This is currently aimed at our use of a SPI bus. The read data functions are what convert the data gotten from the shared bus to the real-world values for each one of the sensors. This was being attempted with ADC_SPI versus STEERING_SPI using just copies of the class.</p>
<div class="fragment"><div class="line">---</div>
<div class="line">title: shared data bus class inheritting</div>
<div class="line">---</div>
<div class="line">classDiagram</div>
<div class="line">    </div>
<div class="line">    class Sensor~SharedDataBusType~{</div>
<div class="line">        SharedBusType* bus</div>
<div class="line">        Sensor&lt;SharedDataBusType&gt;(const SharedDataBusType&amp; bus)</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    class SteeringSensor~SharedDataBusType~{</div>
<div class="line">        float readPosition()</div>
<div class="line">    }</div>
<div class="line">    class LoadSensor~SharedDataBusType~{</div>
<div class="line">        float readForce()</div>
<div class="line">    }</div>
<div class="line">    class CurrentSensor~SharedDataBusType~{</div>
<div class="line">        float readCurrent()</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    Sensor &lt;|-- LoadSensor : implements</div>
<div class="line">    Sensor &lt;|-- SteeringSensor : implements</div>
<div class="line">    Sensor &lt;|-- CurrentSensor : implements</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md18"></a>
state machine documentation</h2>
<div class="fragment"><div class="line">stateDiagram-v2</div>
<div class="line">    startup : STARTUP</div>
<div class="line">    trac_sys_na : TRACTIVE_SYSTEM_NOT_ACTIVE</div>
<div class="line">    trac_sys_a : TRACTIVE_SYSTEM_ACTIVE</div>
<div class="line">    inv_en : ENABLING_INVERTERS</div>
<div class="line">    rtd_s : WAITING_READY_TO_DRIVE_SOUND</div>
<div class="line">    rtd : READY_TO_DRIVE</div>
<div class="line"> </div>
<div class="line">    startup --&gt; trac_sys_na: first tick of state machine</div>
<div class="line">    trac_sys_na --&gt; trac_sys_a: drivetrain voltage over threshold </div>
<div class="line">    trac_sys_a --&gt; trac_sys_na: drivetrain voltage _not_ over threshold</div>
<div class="line">    trac_sys_a --&gt; inv_en: brake and start button pressed</div>
<div class="line">    inv_en --&gt; trac_sys_na: drivetrain voltage _not_ over threshold</div>
<div class="line">    inv_en  --&gt; rtd_s: drivetrain enabled</div>
<div class="line">    rtd_s --&gt; trac_sys_na: drivetrain voltage _not_ over threshold</div>
<div class="line">    rtd_s --&gt; rtd: buzzer done buzzing</div>
<div class="line">    rtd --&gt; trac_sys_na: drivetrain voltage _not_ over threshold</div>
<div class="line">    rtd --&gt; trac_sys_a: drivetrain error occured</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md19"></a>
Running the Tests</h2>
<p >PlatformIO is used for CI unit testing. You can run tests locally using:</p>
<div class="fragment"><div class="line">pio test -e test_env</div>
</div><!-- fragment --><p >The CI checks ensure code compiles for the Teensy and that all tests pass.</p>
<h3><a class="anchor" id="autotoc_md20"></a>
Notes</h3>
<h4><a class="anchor" id="autotoc_md21"></a>
New MCU Code: Definitions and Architecture</h4>
<ul>
<li><b>System Definition</b>: An abstract sub-system that requires logic from the MCU to handle inputs and outputs.</li>
<li><b>Interface Definition</b>: Code to pack/unpack data into internal structures for use by systems or logic.</li>
<li>architecture:<ul>
<li>over-arching state machine</li>
<li>systems level<ul>
<li>inverters (multiple)</li>
<li>pedals</li>
<li>torque / speed controller</li>
<li>dashboard interface</li>
</ul>
</li>
<li>interface level:<ul>
<li>hytech_can interface</li>
<li>spi interfaces: SPI adcs for load cells, steering input, glv, etc.</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="fragment"><div class="line">flowchart LR</div>
<div class="line">    subgraph user_inputs[user defined inputs]</div>
<div class="line">        simulink</div>
<div class="line">        o_params</div>
<div class="line">        CAN_data</div>
<div class="line">        other_protos</div>
<div class="line">    end</div>
<div class="line">    subgraph user_interact[user interfaces]</div>
<div class="line">        fxglv_live</div>
<div class="line">        mcap</div>
<div class="line">        database</div>
<div class="line">        param_server</div>
<div class="line">        </div>
<div class="line">    end</div>
<div class="line">    subgraph user_code_interact[user embedded code interfaces]</div>
<div class="line">        MCU</div>
<div class="line">    end</div>
<div class="line">    subgraph CASE_lib_repo[CASE lib repo gen]</div>
<div class="line">        CASE_lib</div>
<div class="line">        params</div>
<div class="line">        outputs</div>
<div class="line">    end</div>
<div class="line">    subgraph HT_params[HT_params repo gen]</div>
<div class="line">        param_defaults</div>
<div class="line">        nanopb</div>
<div class="line">    end</div>
<div class="line">    simulink[CASE simulink model] --&gt; CASE_lib</div>
<div class="line">    simulink --&gt; params[CASE defined params.json]</div>
<div class="line">    simulink --&gt; outputs[CASE_outputs.proto]</div>
<div class="line">    params --&gt; param_protos[params.proto]</div>
<div class="line">    params --&gt; param_defaults[config defaults header]</div>
<div class="line">    param_defaults --&gt; MCU</div>
<div class="line">    o_params[other params.json] --&gt; param_protos</div>
<div class="line">    outputs --&gt; h_proto</div>
<div class="line">    param_protos --&gt; param_server[parameter server]</div>
<div class="line">    </div>
<div class="line">    h_proto --&gt; data_acq</div>
<div class="line">    data_acq --&gt; fxglv_live[live foxglove]</div>
<div class="line">    data_acq --&gt; mcap[output mcap files]</div>
<div class="line">    CAN_data[CAN message definitions] --&gt; can_protos[CAN messages in hytech.proto]</div>
<div class="line">    can_protos --&gt; h_proto</div>
<div class="line">    mcap --&gt; database[mcap metadata defined database]</div>
<div class="line">    CASE_lib --&gt; MCU</div>
<div class="line">    CAN_data --&gt; dbc_h[dbc to C code gen hytech.h for CAN]</div>
<div class="line">    param_protos --&gt; h_proto[hytech.proto]</div>
<div class="line">    dbc_h --&gt; MCU</div>
<div class="line">    h_proto --&gt; nanopb[protobuf msg defs ht_eth.pb.h]</div>
<div class="line">    nanopb --&gt; MCU</div>
<div class="line">    other_protos[other msgs.proto]</div>
<div class="line">    other_protos --&gt; h_proto</div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
